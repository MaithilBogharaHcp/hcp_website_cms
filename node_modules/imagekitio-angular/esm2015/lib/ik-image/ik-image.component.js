import { Component, ElementRef, Input } from '@angular/core';
import { ImagekitService } from '../imagekitio-angular.service';
import * as i0 from "@angular/core";
import * as i1 from "../imagekitio-angular.service";
export class IkImageComponent {
    constructor(el, imagekit) {
        this.el = el;
        this.imagekit = imagekit;
        this.transformation = [];
        this.url = '';
        this.lqipUrl = '';
        this.onImageLoaded = (event) => {
            const { loading, lqipUrl, url } = this;
            if (loading !== 'lazy' && event.srcElement.src === lqipUrl) {
                this.loadImage(this, url);
            }
        };
    }
    ngOnInit() {
        const options = this.src ? { src: this.src } : { path: this.path };
        options.urlEndpoint = this.urlEndpoint ? this.urlEndpoint : this.imagekit._ikInstance.options.urlEndpoint;
        options.transformation = this.transformation;
        options.transformationPosition = this.transformationPosition;
        options.queryParameters = this.queryParameters;
        options.lqip = this.lqip;
        this.setUrl(options);
    }
    ngOnChanges() {
        this.ngOnInit();
        this.ngAfterViewInit();
    }
    ngAfterViewInit() {
        if (this.loading == 'lazy') {
            const that = this;
            if (this.lqipUrl) {
                // If given LQIP, use that first
                this.loadImage(this, this.lqipUrl);
            }
            const imageObserver = new IntersectionObserver((entry, observer) => {
                // Always load the original image when intersecting
                that.handleIntersectionObserver(entry, observer, that.loadImage, that, that.url);
            });
            imageObserver.observe(this.el.nativeElement);
        }
        else {
            // If given LQIP, use that first
            this.loadImage(this, this.lqipUrl ? this.lqipUrl : this.url);
        }
    }
    handleIntersectionObserver(entry, observer, loadImageFunc, context, url) {
        if (entry[0] && entry[0].isIntersecting) {
            let image = entry[0].target;
            loadImageFunc(context, url);
            observer.unobserve(image);
        }
    }
    setUrl(options) {
        const config = this.getConfigObject(options);
        this.url = this.imagekit.getUrl(config);
        if (options.lqip && options.lqip.active === true) {
            this.lqipUrl = this.constructLqipUrl(options, options.lqip);
        }
    }
    constructLqipUrl(options, lqip) {
        if (lqip && lqip.active) {
            var quality = Math.round(lqip.quality || lqip.threshold || 20);
            var blur = Math.round(lqip.blur || 6);
            var newTransformation = options.transformation ? [...options.transformation] : [];
            if (lqip.raw && typeof lqip.raw === "string" && lqip.raw.trim() != "") {
                newTransformation.push({
                    raw: lqip.raw.trim()
                });
            }
            else {
                newTransformation.push({
                    quality: String(quality),
                    blur: String(blur),
                });
            }
            return this.imagekit.ikInstance.url(Object.assign(Object.assign({}, options), { transformation: newTransformation }));
        }
    }
    getConfigObject(options) {
        const config = {
            transformation: options.transformation
        };
        if (options.urlEndpoint) {
            config['urlEndpoint'] = options.urlEndpoint;
        }
        else {
            throw new Error('Missing urlEndpoint initialization!');
        }
        if (options.queryParameters) {
            config['queryParameters'] = options.queryParameters;
        }
        if (options.src) {
            config['src'] = options.src;
            config['transformationPosition'] = 'query';
        }
        else if (options.path) {
            config['path'] = options.path;
            if (options.transformationPosition) {
                config['transformationPosition'] = options.transformationPosition;
            }
        }
        else {
            throw new Error('Missing src / path during initialization!');
        }
        return config;
    }
    loadImage(context, url) {
        const nativeElement = context.el.nativeElement;
        const attributes = nativeElement.attributes;
        const attrsToSet = context.namedNodeMapToObject(attributes);
        attrsToSet['src'] = url;
        const image = nativeElement.children[0];
        context.setElementAttributes(image, attrsToSet);
    }
    namedNodeMapToObject(source) {
        let target = {};
        Object.keys(source).forEach(index => {
            const name = source[index].name;
            const value = source[index].value;
            target[name] = value;
        });
        return target;
    }
    ;
    setElementAttributes(element, attributesLiteral) {
        Object.keys(attributesLiteral).filter(attrName => attrName !== 'loading').forEach(attrName => {
            element.setAttribute(attrName, attributesLiteral[attrName]);
        });
    }
}
IkImageComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: IkImageComponent, deps: [{ token: i0.ElementRef }, { token: i1.ImagekitService }], target: i0.ɵɵFactoryTarget.Component });
IkImageComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: IkImageComponent, selector: "ik-image", inputs: { src: "src", path: "path", urlEndpoint: "urlEndpoint", transformation: "transformation", transformationPosition: "transformationPosition", queryParameters: "queryParameters", lqip: "lqip", loading: "loading" }, usesOnChanges: true, ngImport: i0, template: `<img src='' (load)="onImageLoaded($event)">`, isInline: true });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: IkImageComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ik-image',
                    template: `<img src='' (load)="onImageLoaded($event)">`,
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.ImagekitService }]; }, propDecorators: { src: [{
                type: Input,
                args: ['src']
            }], path: [{
                type: Input,
                args: ['path']
            }], urlEndpoint: [{
                type: Input,
                args: ['urlEndpoint']
            }], transformation: [{
                type: Input,
                args: ['transformation']
            }], transformationPosition: [{
                type: Input,
                args: ['transformationPosition']
            }], queryParameters: [{
                type: Input,
                args: ['queryParameters']
            }], lqip: [{
                type: Input,
                args: ['lqip']
            }], loading: [{
                type: Input,
                args: ['loading']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWstaW1hZ2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvaW1hZ2VraXRpby1hbmd1bGFyL3NyYy9saWIvaWstaW1hZ2UvaWstaW1hZ2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXlCLFVBQVUsRUFBRSxLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLCtCQUErQixDQUFDOzs7QUFRaEUsTUFBTSxPQUFPLGdCQUFnQjtJQWMzQixZQUFvQixFQUFjLEVBQVUsUUFBeUI7UUFBakQsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBVjVDLG1CQUFjLEdBQTBCLEVBQUUsQ0FBQztRQUtwRSxRQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ1QsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQTBDYixrQkFBYSxHQUFHLENBQUMsS0FBNkMsRUFBRSxFQUFFO1lBQ2hFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztZQUV2QyxJQUFJLE9BQU8sS0FBSyxNQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEtBQUssT0FBTyxFQUFFO2dCQUMxRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQzthQUMzQjtRQUNILENBQUMsQ0FBQztJQTNDRixDQUFDO0lBRUQsUUFBUTtRQUNOLE1BQU0sT0FBTyxHQUE2QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUMsQ0FBQztRQUN6RixPQUFPLENBQUMsV0FBVyxHQUFHLElB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U0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgQWZ0ZXJWaWV3SW5pdCwgT25Jbml0LCBFbGVtZW50UmVmLCBJbnB1dCwgT25DaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJbWFnZWtpdFNlcnZpY2UgfSBmcm9tICcuLi9pbWFnZWtpdGlvLWFuZ3VsYXIuc2VydmljZSc7XG5pbXBvcnQgeyBEaWN0LCBRdWVyeVBhcmFtZXRlcnMsIElrSW1hZ2VDb21wb25lbnRPcHRpb25zLCBMcWlwT3B0aW9ucyB9IGZyb20gJy4uL3V0aWxpdHkvaWstdHlwZS1kZWYtY29sbGVjdGlvbidcbmltcG9ydCB7IFRyYW5zZm9ybWF0aW9uIH0gZnJvbSAnaW1hZ2VraXQtamF2YXNjcmlwdC9kaXN0L3NyYy9pbnRlcmZhY2VzL1RyYW5zZm9ybWF0aW9uJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaWstaW1hZ2UnLFxuICB0ZW1wbGF0ZTogYDxpbWcgc3JjPScnIChsb2FkKT1cIm9uSW1hZ2VMb2FkZWQoJGV2ZW50KVwiPmAsXG59KVxuZXhwb3J0IGNsYXNzIElrSW1hZ2VDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgnc3JjJykgc3JjOiBzdHJpbmc7XG4gIEBJbnB1dCgncGF0aCcpIHBhdGg6IHN0cmluZztcbiAgQElucHV0KCd1cmxFbmRwb2ludCcpIHVybEVuZHBvaW50OiBzdHJpbmc7XG4gIEBJbnB1dCgndHJhbnNmb3JtYXRpb24nKSB0cmFuc2Zvcm1hdGlvbjogQXJyYXk8VHJhbnNmb3JtYXRpb24+ID0gW107XG4gIEBJbnB1dCgndHJhbnNmb3JtYXRpb25Qb3NpdGlvbicpIHRyYW5zZm9ybWF0aW9uUG9zaXRpb246IFwicGF0aFwiIHwgXCJxdWVyeVwiO1xuICBASW5wdXQoJ3F1ZXJ5UGFyYW1ldGVycycpIHF1ZXJ5UGFyYW1ldGVyczogUXVlcnlQYXJhbWV0ZXJzO1xuICBASW5wdXQoJ2xxaXAnKSBscWlwOiBMcWlwT3B0aW9ucztcbiAgQElucHV0KCdsb2FkaW5nJykgbG9hZGluZzogc3RyaW5nO1xuICB1cmwgPSAnJztcbiAgbHFpcFVybCA9ICcnO1xuICBcbiAgb2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXI7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSBpbWFnZWtpdDogSW1hZ2VraXRTZXJ2aWNlKSB7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBjb25zdCBvcHRpb25zOiBJa0ltYWdlQ29tcG9uZW50T3B0aW9ucyA9ICB0aGlzLnNyYyA/IHtzcmM6IHRoaXMuc3JjfSA6IHtwYXRoOiB0aGlzLnBhdGh9O1xuICAgIG9wdGlvbnMudXJsRW5kcG9pbnQgPSB0aGlzLnVybEVuZHBvaW50ID8gdGhpcy51cmxFbmRwb2ludCA6IHRoaXMuaW1hZ2VraXQuX2lrSW5zdGFuY2Uub3B0aW9ucy51cmxFbmRwb2ludDtcbiAgICBvcHRpb25zLnRyYW5zZm9ybWF0aW9uID0gdGhpcy50cmFuc2Zvcm1hdGlvbjtcbiAgICBvcHRpb25zLnRyYW5zZm9ybWF0aW9uUG9zaXRpb24gPSB0aGlzLnRyYW5zZm9ybWF0aW9uUG9zaXRpb247XG4gICAgb3B0aW9ucy5xdWVyeVBhcmFtZXRlcnMgPSB0aGlzLnF1ZXJ5UGFyYW1ldGVycztcbiAgICBvcHRpb25zLmxxaXAgPSB0aGlzLmxxaXA7XG4gICAgdGhpcy5zZXRVcmwob3B0aW9ucyk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLm5nT25Jbml0KCk7XG4gICAgdGhpcy5uZ0FmdGVyVmlld0luaXQoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBpZih0aGlzLmxvYWRpbmcgPT0gJ2xhenknKXtcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgaWYodGhpcy5scWlwVXJsKXtcbiAgICAgICAgLy8gSWYgZ2l2ZW4gTFFJUCwgdXNlIHRoYXQgZmlyc3RcbiAgICAgICAgdGhpcy5sb2FkSW1hZ2UodGhpcywgdGhpcy5scWlwVXJsKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGltYWdlT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoXG4gICAgICAgIChlbnRyeTogYW55LCBvYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXIpPT57XG4gICAgICAgICAgLy8gQWx3YXlzIGxvYWQgdGhlIG9yaWdpbmFsIGltYWdlIHdoZW4gaW50ZXJzZWN0aW5nXG4gICAgICAgICAgdGhhdC5oYW5kbGVJbnRlcnNlY3Rpb25PYnNlcnZlcihlbnRyeSwgb2JzZXJ2ZXIsIHRoYXQubG9hZEltYWdlLCB0aGF0LCB0aGF0LnVybCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBpbWFnZU9ic2VydmVyLm9ic2VydmUodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSWYgZ2l2ZW4gTFFJUCwgdXNlIHRoYXQgZmlyc3RcbiAgICAgIHRoaXMubG9hZEltYWdlKHRoaXMsIHRoaXMubHFpcFVybCA/IHRoaXMubHFpcFVybCA6IHRoaXMudXJsKTtcbiAgICB9XG4gIH1cblxuICBvbkltYWdlTG9hZGVkID0gKGV2ZW50OiB7IHNyY0VsZW1lbnQ6IHsgc3JjOiBzdHJpbmc7IH0gfCBhbnkgfSkgPT4ge1xuICAgIGNvbnN0IHsgbG9hZGluZywgbHFpcFVybCwgdXJsIH0gPSB0aGlzO1xuXG4gICAgaWYgKGxvYWRpbmcgIT09ICdsYXp5JyAmJiBldmVudC5zcmNFbGVtZW50LnNyYyA9PT0gbHFpcFVybCkge1xuICAgICAgdGhpcy5sb2FkSW1hZ2UodGhpcywgdXJsKTtcbiAgICB9XG4gIH07XG5cbiAgaGFuZGxlSW50ZXJzZWN0aW9uT2JzZXJ2ZXIgKGVudHJ5OiBhbnksIG9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlciwgXG4gICAgbG9hZEltYWdlRnVuYzogRnVuY3Rpb24sIGNvbnRleHQ6IElrSW1hZ2VDb21wb25lbnQsIHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGVudHJ5WzBdICYmIGVudHJ5WzBdLmlzSW50ZXJzZWN0aW5nKSB7XG4gICAgICBsZXQgaW1hZ2UgPSBlbnRyeVswXS50YXJnZXQ7XG4gICAgICBsb2FkSW1hZ2VGdW5jKGNvbnRleHQsIHVybCk7XG4gICAgICBvYnNlcnZlci51bm9ic2VydmUoaW1hZ2UpO1xuICAgIH1cbiAgfVxuXG4gIHNldFVybChvcHRpb25zOiBJa0ltYWdlQ29tcG9uZW50T3B0aW9ucyk6IHZvaWQge1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuZ2V0Q29uZmlnT2JqZWN0KG9wdGlvbnMpO1xuICAgIHRoaXMudXJsID0gdGhpcy5pbWFnZWtpdC5nZXRVcmwoY29uZmlnKTtcbiAgICBpZiAob3B0aW9ucy5scWlwICYmIG9wdGlvbnMubHFpcC5hY3RpdmUgPT09IHRydWUpIHtcbiAgICAgIHRoaXMubHFpcFVybCA9IHRoaXMuY29uc3RydWN0THFpcFVybChvcHRpb25zLCBvcHRpb25zLmxxaXApO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdExxaXBVcmwob3B0aW9uczpJa0ltYWdlQ29tcG9uZW50T3B0aW9ucywgbHFpcDogTHFpcE9wdGlvbnMpOiBhbnkge1xuICAgIGlmIChscWlwICYmIGxxaXAuYWN0aXZlKSB7XG4gICAgICB2YXIgcXVhbGl0eSA9IE1hdGgucm91bmQobHFpcC5xdWFsaXR5IHx8IGxxaXAudGhyZXNob2xkIHx8IDIwKTtcbiAgICAgIHZhciBibHVyID0gTWF0aC5yb3VuZChscWlwLmJsdXIgfHwgNik7XG4gICAgICB2YXIgbmV3VHJhbnNmb3JtYXRpb24gPSBvcHRpb25zLnRyYW5zZm9ybWF0aW9uID8gWy4uLm9wdGlvbnMudHJhbnNmb3JtYXRpb25dIDogW107XG4gICAgICBpZiAobHFpcC5yYXcgJiYgdHlwZW9mIGxxaXAucmF3ID09PSBcInN0cmluZ1wiICYmIGxxaXAucmF3LnRyaW0oKSAhPSBcIlwiKSB7XG4gICAgICAgIG5ld1RyYW5zZm9ybWF0aW9uLnB1c2goe1xuICAgICAgICAgIHJhdzogbHFpcC5yYXcudHJpbSgpXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3VHJhbnNmb3JtYXRpb24ucHVzaCh7XG4gICAgICAgICAgcXVhbGl0eTogU3RyaW5nKHF1YWxpdHkpLFxuICAgICAgICAgIGJsdXI6IFN0cmluZyhibHVyKSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmltYWdla2l0LmlrSW5zdGFuY2UudXJsKHtcbiAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgdHJhbnNmb3JtYXRpb246IG5ld1RyYW5zZm9ybWF0aW9uXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRDb25maWdPYmplY3Qob3B0aW9uczogSWtJbWFnZUNvbXBvbmVudE9wdGlvbnMpOiBhbnkge1xuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIHRyYW5zZm9ybWF0aW9uIDogb3B0aW9ucy50cmFuc2Zvcm1hdGlvblxuICAgIH07XG4gICAgXG4gICAgaWYgKG9wdGlvbnMudXJsRW5kcG9pbnQpIHtcbiAgICAgIGNvbmZpZ1sndXJsRW5kcG9pbnQnXSA9IG9wdGlvbnMudXJsRW5kcG9pbnQ7XG4gICAgfWVsc2V7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgdXJsRW5kcG9pbnQgaW5pdGlhbGl6YXRpb24hJyk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzKSB7XG4gICAgICBjb25maWdbJ3F1ZXJ5UGFyYW1ldGVycyddID0gb3B0aW9ucy5xdWVyeVBhcmFtZXRlcnM7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnNyYykge1xuICAgICAgY29uZmlnWydzcmMnXSA9IG9wdGlvbnMuc3JjO1xuICAgICAgY29uZmlnWyd0cmFuc2Zvcm1hdGlvblBvc2l0aW9uJ10gPSAncXVlcnknO1xuICAgIH0gZWxzZSBpZiAob3B0aW9ucy5wYXRoKSB7XG4gICAgICBjb25maWdbJ3BhdGgnXSA9IG9wdGlvbnMucGF0aDtcbiAgICAgIGlmIChvcHRpb25zLnRyYW5zZm9ybWF0aW9uUG9zaXRpb24pIHtcbiAgICAgICAgY29uZmlnWyd0cmFuc2Zvcm1hdGlvblBvc2l0aW9uJ10gPSBvcHRpb25zLnRyYW5zZm9ybWF0aW9uUG9zaXRpb247XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBzcmMgLyBwYXRoIGR1cmluZyBpbml0aWFsaXphdGlvbiEnKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZztcbiAgfVxuXG4gIGxvYWRJbWFnZShjb250ZXh0OiBJa0ltYWdlQ29tcG9uZW50LCB1cmw6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IG5hdGl2ZUVsZW1lbnQgPSBjb250ZXh0LmVsLm5hdGl2ZUVsZW1lbnQ7XG4gICAgY29uc3QgYXR0cmlidXRlcyA9IG5hdGl2ZUVsZW1lbnQuYXR0cmlidXRlcztcbiAgICBjb25zdCBhdHRyc1RvU2V0ID0gY29udGV4dC5uYW1lZE5vZGVNYXBUb09iamVjdChhdHRyaWJ1dGVzKTtcbiAgICBhdHRyc1RvU2V0WydzcmMnXSA9IHVybDtcbiAgICBjb25zdCBpbWFnZSA9IG5hdGl2ZUVsZW1lbnQuY2hpbGRyZW5bMF07XG4gICAgY29udGV4dC5zZXRFbGVtZW50QXR0cmlidXRlcyhpbWFnZSwgYXR0cnNUb1NldCk7XG4gIH1cblxuICBuYW1lZE5vZGVNYXBUb09iamVjdChzb3VyY2U6IE5hbWVkTm9kZU1hcCk6IERpY3Qge1xuICAgIGxldCB0YXJnZXQ6IERpY3QgPSB7fTtcbiAgICBPYmplY3Qua2V5cyhzb3VyY2UpLmZvckVhY2goaW5kZXggPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IHNvdXJjZVtpbmRleF0ubmFtZTtcbiAgICAgIGNvbnN0IHZhbHVlID0gc291cmNlW2luZGV4XS52YWx1ZTtcbiAgICAgIHRhcmdldFtuYW1lXSA9IHZhbHVlO1xuICAgIH0pO1xuICAgIHJldHVybiB0YXJnZXQ7XG4gIH07XG5cbiAgc2V0RWxlbWVudEF0dHJpYnV0ZXMoZWxlbWVudDogYW55LCBhdHRyaWJ1dGVzTGl0ZXJhbDogRGljdCk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKGF0dHJpYnV0ZXNMaXRlcmFsKS5maWx0ZXIoYXR0ck5hbWUgPT4gYXR0ck5hbWUgIT09ICdsb2FkaW5nJykuZm9yRWFjaChhdHRyTmFtZSA9PiB7XG4gICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBhdHRyaWJ1dGVzTGl0ZXJhbFthdHRyTmFtZV0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=